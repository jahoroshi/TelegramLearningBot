import logging
import random
from typing import Callable, Dict, Any, Awaitable

from aiogram import BaseMiddleware, exceptions
from aiogram.enums import ParseMode
from aiogram.types import TelegramObject, CallbackQuery

from bot import bot

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class GettingStartedTips(BaseMiddleware):
    def __init__(self):
        self._last_msg = 0
        self._messages = {
            'deck_details_': '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π.\nü§ì –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–∑—É—á–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏, –Ω–∞–∂–º–∏—Ç–µ <b>"–£—á–∏—Ç—å"</b>.\nüßê –ö–Ω–æ–ø–∫–∞ <b>"–°–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏"</b> –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.\nüöö –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ä–∞–∑—É –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É <b>"–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å"</b>.',
            'show_cards_': '–≠—Ç–æ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏.\n–ù–∞–∂–º–∏—Ç–µ "Add card", —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É.\n–ö–Ω–æ–ø–∫–∞ "Edit card" –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏.\n–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "Delete card".',
            'delete_card': '–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–¥–Ω—É –∫–∞—Ä—Ç–æ—á–∫—É, –ø—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏—Ç–µ –µ—ë –Ω–æ–º–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞. –ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–µ–∫, –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –∏—Ö –Ω–æ–º–µ—Ä–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª –∏–ª–∏ –∑–∞–ø—è—Ç—É—é.',
            'add_card_': 'üÇ† –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Å—Ç–æ—Ä–æ–Ω—É –∫–∞—Ä—Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –∏–∑—É—á–∞—Ç—å.\n–û–Ω–∞ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –ø–µ—Ä–≤–æ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–∑—É—á–µ–Ω–∏—è.\nüÇ°üÇ† –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É—á–∏—Ç—å –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞—Ä—Ç–æ—á–∫–∏, —É–∫–∞–∂–∏—Ç–µ —ç—Ç–æ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏.',
            'edit_card': '–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É, –≤–≤–µ–¥–∏—Ç–µ –µ—ë –Ω–æ–º–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞.\n –ó–∞—Ç–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –ø–µ—Ä–µ–¥–Ω—é—é –∏ –∑–∞–¥–Ω—é—é —Å—Ç–æ—Ä–æ–Ω—ã.\n –ï—Å–ª–∏ –∫–∞–∫–∞—è-—Ç–æ —Å—Ç–æ—Ä–æ–Ω–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ—ë –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ ‚Äî –ø–æ–ª–µ –ø—É—Å—Ç—ã–º –æ—Å—Ç–∞–≤–ª—è—Ç—å –Ω–µ–ª—å–∑—è.\n –í –∫–æ–Ω—Ü–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å, —Ö–æ—Ç–∏—Ç–µ –ª–∏ –≤—ã —É—á–∏—Ç—å –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞—Ä—Ç–æ—á–∫–∏.',
            'import_cards_': '–í —ç—Ç–æ–º –æ–∫–Ω–µ —Ç—ã –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é.\n–†–∞–∑–¥–µ–ª—è–π –ø–µ—Ä–µ–¥–Ω—é—é –∏ –∑–∞–¥–Ω—é—é —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–∏–º–≤–æ–ª–æ–º ;.\n–ö–∞–∂–¥—É—é –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞—á–∏–Ω–∞–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî 4096 —Å–∏–º–≤–æ–ª–æ–≤.',
            'choose_study_format_': '–ó–¥–µ—Å—å —Ç—ã –º–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å, –∫–∞–∫ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ª–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏.\n–ï—Å–ª–∏ –≤—ã–±–µ—Ä–µ—à—å —Ç–µ–∫—Å—Ç, —Ç–æ –æ–Ω–∞ –±—É–¥–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å—Å—è –≤ –≤–∏–¥–µ —Ç–µ–∫—Å—Ç–∞.\n–ï—Å–ª–∏ –≤—ã–±–µ—Ä–µ—à—å –∑–≤—É–∫, —Ç–æ –ª–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –±—É–¥–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –≥–æ–ª–æ—Å–æ–º. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –Ω–∞ —Å–ª—É—Ö.',
            'start_studying_': '–≠—Ç–æ —Ä–µ–∂–∏–º –∏–∑—É—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫.\n–ï—Å–ª–∏ —Ç—ã —É–∂–µ –∑–Ω–∞–µ—à—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É –∏ –Ω–µ —Ö–æ—á–µ—à—å –µ—ë –¥–∞–ª—å—à–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å, –Ω–∞–∂–º–∏ "already known" –≤ —Å–∞–º–æ–º –Ω–∏–∑—É.\n–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∑–∞–¥–Ω—é—é —Å—Ç–æ—Ä–æ–Ω—É –∫–∞—Ä—Ç–æ—á–∫–∏, –Ω–∞–∂–º–∏ "show back".',
            'button_show_back': '–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—Å–ø–æ–º–Ω–∏—à—å –æ—Ç–≤–µ—Ç, –æ—Ü–µ–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç "Again" (—Å–∞–º–æ–µ —Å–ª–æ–∂–Ω–æ–µ) –¥–æ "Easy" (—Å–∞–º–æ–µ –ª—ë–≥–∫–æ–µ).\n–ü–æ—Å–ª–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞.',
            'rating': random.choice(('–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –≤—Å–ø–æ–º–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏,\n–ø—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞–∂–∏–º–∞—Ç—å "show back", –∏—Å–ø–æ–ª—å–∑—É–π –æ–¥–Ω—É –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Å–µ–±–µ –≤—Å–ø–æ–º–Ω–∏—Ç—å.\n–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–µ–π –æ—Ü–µ–Ω–∫–∏ –Ω–∞—à –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–π–º–µ—Ç, –∫–æ–≥–¥–∞ –ª—É—á—à–µ —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –ª—É—á—à–µ–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.', '–ù–∞–∂–º–∏ "show back" –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–æ–π, –∞ –∑–∞—Ç–µ–º –æ—Ü–µ–Ω–∏, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–æ –±—ã–ª–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å.')),
            '/addcard': '–ï—Å—Ç—å –∏ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –±—ã—Å—Ç—Ä–µ–µ! –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –¥–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: –≤ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç —Å –ª–∏—Ü–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –∫–∞—Ä—Ç–æ—á–∫–∏, –∞ –≤–æ –≤—Ç–æ—Ä–æ–º ‚Äî —Ç–µ–∫—Å—Ç —Å –∑–∞–¥–Ω–µ–π —Å—Ç–æ—Ä–æ–Ω—ã. üìù‚ú®\n\n–ö–∞–∫ —Ç–æ–ª—å–∫–æ –±–æ—Ç –ø–æ–ª—É—á–∏—Ç –æ–±–∞ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ–Ω –ø–æ–π–º—ë—Ç, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –≤–∞–º –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é. –≠—Ç–æ –ª–µ–≥–∫–æ –∏ –±—ã—Å—Ç—Ä–æ! –£–¥–∞—á–∏! üòä',
            '': '',
            '': '',
            '': '',
        }
        self._tips_count = {tip: 1 for tip in self._messages}
        self._tips_count['rating'] = 5

    @property
    def last_msg(self):
        return self._last_msg

    @last_msg.setter
    def last_msg(self, msg: int):
        self._last_msg = msg

    async def __call__(self,
                       handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
                       event: TelegramObject,
                       data: Dict[str, Any]) -> Any:

        if isinstance(event, CallbackQuery):
            message = event.message
            trigger = event.data
        else:
            message = event
            trigger = event.text

        event_handler = await handler(event, data)

        self.chat_id = message.chat.id
        if trigger.startswith('back_to_decks') or trigger.startswith('deck_details_'):
            await self._delete_message()

        tip_message = await self._message_handler(trigger)
        if tip_message:
            if self._last_msg != 0:
                await self._delete_message()
            emoji = random.choice(('üö®', 'üí°', '‚òùÔ∏è', 'üöÄ', 'üö©'))
            msg = await message.answer(f'{emoji} Tip! {tip_message}', parse_mode=ParseMode.HTML)
            self._last_msg = msg.message_id

        return event_handler

    async def _message_handler(self, trigger: str):
        for trig, tip in self._messages.items():
            if trigger in ('Again', 'Hard', 'Good', 'Easy'):
                trigger = 'rating'
            if trigger.startswith(trig):
                if self._tips_count[trig] == 0:
                    return
                else:
                    self._tips_count[trig] -= 1
                    print(self._tips_count)
                    if sum(self._tips_count.values()) == 0:
                        await self._unregister_middleware()
                    return tip

    async def _unregister_middleware(self):
        from app.handlers import main_router
        main_router.message.middleware.unregister(self)
        main_router.callback_query.middleware.unregister(self)

    async def _delete_message(self):
        try:
            await bot.delete_message(chat_id=self.chat_id, message_id=self._last_msg)
        except Exception as e:
            logger.error(f"Failed to delete message {self._last_msg} in chat {self.chat_id}: {e}")